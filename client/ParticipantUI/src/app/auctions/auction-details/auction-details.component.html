<div *ngIf="auctionDetails && user"
     class="container py-4">
  <div class="row g-4">
    <div class="col-lg-4 col-md-12">
      <div class="card shadow-sm border-0">
        <div class="card-body p-0">
          <div id="auctionImagesCarousel"
               class="carousel slide"
               data-bs-ride="carousel">
            <div class="carousel-inner rounded">
              <div *ngFor="let imageUrl of auctionDetails.imageUrls; let i = index"
                   class="carousel-item"
                   [class.active]="i === 0">
                <img [src]="imageUrl"
                     class="d-block w-100 img-fluid rounded"
                     alt="Auction Lot Image">
              </div>
            </div>
            <div *ngIf="auctionDetails.imageUrls!.length > 1">
              <button class="carousel-control-prev"
                      type="button"
                      data-bs-target="#auctionImagesCarousel"
                      data-bs-slide="prev">
                <span class="carousel-control-prev-icon"
                      aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
              </button>
              <button class="carousel-control-next"
                      type="button"
                      data-bs-target="#auctionImagesCarousel"
                      data-bs-slide="next">
                <span class="carousel-control-next-icon"
                      aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
              </button>
            </div>
            <div *ngIf="auctionDetails.imageUrls!.length > 1"
                 class="carousel-indicators position-relative mt-3">
              <button *ngFor="let imageUrl of auctionDetails.imageUrls; let i = index"
                      type="button"
                      data-bs-target="#auctionImagesCarousel"
                      [attr.data-bs-slide-to]="i"
                      [class.active]="i === 0"
                      [attr.aria-current]="i === 0 ? 'true' : null"
                      [attr.aria-label]="'Slide ' + (i + 1)"
                      class="thumbnail-indicator"
                      style="width: 60px; height: 60px; margin: 0 5px; border-radius: 5px; overflow: hidden; border: 2px solid transparent;">
                <img [src]="imageUrl"
                     class="d-block w-100 h-100 object-fit-cover"
                     alt="Thumbnail {{i+1}}">
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-8 col-md-12">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body d-flex flex-column justify-content-between">
          <div>
            <h1 class="card-title mb-3">{{ auctionDetails.lotTitle }}</h1>

            <span class="badge fs-6 mb-3"
                  [ngClass]="{
                    'bg-success': auctionDetails.status === AuctionStatusEnum.Active,
                    'bg-warning text-dark': auctionDetails.status === AuctionStatusEnum.Pending,
                    'bg-danger': auctionDetails.status === AuctionStatusEnum.CancelledByAuctioneer || auctionDetails.status === AuctionStatusEnum.CancelledByModerator,
                    'bg-info text-dark': auctionDetails.status === AuctionStatusEnum.Finished
                  }">
              {{ auctionStatus }}
            </span>

            <div class="row g-2 mb-3">
              <div class="col-sm-6">
                <strong><i class="fa-solid fa-tag me-2 text-muted"></i>Category:</strong> {{ auctionDetails.category }}
              </div>
              <div class="col-sm-6">
                <strong><i class="fa-solid fa-gavel me-2 text-muted"></i>Auctioneer:</strong>
                <a [routerLink]="['/users', auctionDetails.auctioneer!.userId]"
                   class="text-decoration-none">
                  {{ auctionDetails.auctioneer!.username }}
                </a>
              </div>

              <ng-container
                            *ngIf="auctionDetails.status !== AuctionStatusEnum.CancelledByAuctioneer && auctionDetails.status !== AuctionStatusEnum.CancelledByModerator">
                <div class="col-sm-6">
                  <strong><i class="fa-solid fa-sack-dollar me-2 text-muted"></i>Current bid:</strong>
                  <span class="fs-5 text-success">${{ auctionDetails.currentPrice }}</span> / <span
                        class="text-muted">${{ auctionDetails.startPrice }}</span>
                </div>
                <div class="col-sm-6"
                     *ngIf="auctionDetails.averageScore">
                  <strong><i class="fa-solid fa-star me-2"
                       [ngStyle]="{ 'color': '#b6d714' }"></i>Score:</strong>
                  {{ auctionDetails.averageScore | number: '1.1-1' }}
                </div>
                <div class="col-sm-6">
                  <strong><i class="fa-solid fa-hourglass-start me-2 text-muted"></i>Start time:</strong>
                  {{ auctionDetails.startTime | date: 'MM-dd-yyyy hh:mm' }}
                </div>
                <div class="col-sm-6">
                  <strong><i class="fa-solid fa-hourglass-end me-2 text-muted"></i>Finish time:</strong>
                  {{ auctionDetails.finishTime | date: 'MM-dd-yyyy hh:mm' }}
                </div>
                <div class="col-sm-6">
                  <strong><i class="fa-solid fa-flag-checkered me-2 text-muted"></i>Finish type:</strong>
                  {{ auctionDetails.finishMethod }}
                </div>
              </ng-container>

              <div class="col-sm-6">
                <strong><i class="fa-solid fa-hand-holding-dollar me-2 text-muted"></i>Auction type:</strong>
                {{ auctionDetails.type }}
              </div>
              <div class="col-sm-6"
                   *ngIf="auctionDetails.status === AuctionStatusEnum.Finished && auctionDetails.winner">
                <strong><i class="fa-solid fa-crown me-2 text-muted"></i>Winner:</strong>
                <a routerLink="/profile"
                   [queryParams]="{ userId: auctionDetails.winner.userId }"
                   class="text-decoration-none">
                  {{ auctionDetails.winner!.username }}
                </a>
              </div>
            </div>

            <div *ngIf="auctionDetails.status === AuctionStatusEnum.Active"
                 class="alert alert-info text-center mt-3">
              <h5 class="mb-0"><i class="fa-solid fa-clock me-2"></i>Time Left: <span class="fw-bold">{{ timeLeft
                  }}</span></h5>
            </div>

          </div>

          <ng-template #auctionActionsPopContent>
            <div class="list-group list-group-flush">
              <a *ngIf="auctionDetails.status === AuctionStatusEnum.Finished &&
                        !auctionDetails.isDeliveryPerformed &&
                        ((auctionDetails.type === 'Dutch Auction' && auctionDetails.winner!.userId === user.userId) ||
                         (auctionDetails.type !== 'Dutch Auction' && auctionDetails.auctioneer!.userId === user.userId))"
                 [routerLink]="['/auctions', auctionDetails.id, 'perform-delivery']"
                 class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="fa-solid fa-truck me-2"></i>Go to Delivery
              </a>
              <a *ngIf="auctionDetails.status === AuctionStatusEnum.Finished &&
                        !auctionDetails.isPaymentPerformed &&
                        ((auctionDetails.type === 'Dutch Auction' && auctionDetails.auctioneer!.userId === user.userId) ||
                         (auctionDetails.type !== 'Dutch Auction' && auctionDetails.winner!.userId === user.userId))"
                 [routerLink]="['/auctions', auctionDetails.id, 'checkout']"
                 class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="fa-solid fa-credit-card me-2"></i>Go to Payment
              </a>
              <button *ngIf="auctionDetails.auctioneer!.userId != user.userId"
                      class="list-group-item list-group-item-action d-flex align-items-center"
                      (click)="open(complaintOnAuctionModal)">
                Complain
              </button>
              <button *ngIf="auctionDetails.status === AuctionStatusEnum.Active && auctionDetails.auctioneer!.userId == user.userId"
                      class="list-group-item list-group-item-action d-flex align-items-center"
                      (click)="open(cancelAuctionModal)">
                Cancel Auction
              </button>
            </div>
          </ng-template>

          <div *ngIf="auctionDetails.status === AuctionStatusEnum.Active"
               class="d-flex justify-content-between align-items-center mt-4">
            <button *ngIf="auctionDetails.status === AuctionStatusEnum.Active"
                    class="btn default-btn-background btn-lg me-3"
                    (click)="handleBidButtonClick()"
                    [disabled]="isPlacingBidDisabled">
              <i class="fa-solid fa-dollar-sign me-2"></i>Place a Bid
            </button>

            <button *ngIf="auctionActionsAreAvailable"
                    type="button"
                    class="btn btn-outline-secondary actions-button"
                    placement="bottom"
                    [ngbPopover]="auctionActionsPopContent">
              <i class="fa-solid fa-ellipsis-h"></i>
            </button>
          </div>

          <div *ngIf="auctionDetails.status !== AuctionStatusEnum.Active"
               class="d-flex justify-content-end align-items-center mt-4">
            <button *ngIf="auctionActionsAreAvailable"
                    type="button"
                    class="btn btn-outline-secondary actions-button"
                    placement="bottom"
                    [ngbPopover]="auctionActionsPopContent">
              <i class="fa-solid fa-ellipsis-h"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-5">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h3 class="card-title mb-3 text-secondary">Lot Description</h3>
          <p class="card-text text-muted">{{ auctionDetails.lotDescription }}</p>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="auctionDetails.status !== AuctionStatusEnum.CancelledByAuctioneer && auctionDetails.status !== AuctionStatusEnum.CancelledByModerator"
       class="row mt-4">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h3 class="card-title mb-3 text-secondary">Bids History</h3>
          <data-table #bidsDataTable
                      *ngIf="bidsDataTableOptions"
                      [apiUrl]="getAuctionBidsApiUrl()"
                      [options]="bidsDataTableOptions">
          </data-table>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="auctionDetails.status !== AuctionStatusEnum.CancelledByAuctioneer && auctionDetails.status !== AuctionStatusEnum.CancelledByModerator"
       class="row mt-4 mb-5">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <comments [auction]="auctionDetails"></comments>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #setBidModal
             let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Place Your Bid</h4>
    <button type="button"
            class="btn-close"
            aria-label="Close"
            (click)="modal.dismiss('Cross click')"></button>
  </div>
  <div class="modal-body">
    <form *ngIf="setBidForm"
          [formGroup]="setBidForm">
      <div class="mb-3">
        <label for="amount"
               class="form-label fw-bold">Amount:</label>
        <input type="number"
               id="amount"
               [min]="minBidAmount!"
               [max]="maxBidAmount!"
               class="form-control"
               formControlName="amount"
               [ngClass]="{'is-invalid': !amount?.valid && (amount?.dirty || amount?.touched)}" />
        <div *ngIf="!amount?.valid && (amount?.dirty || amount?.touched)"
             class="invalid-feedback">
          <div *ngIf="amount?.errors?.['required']">Amount is required.</div>
          <div *ngIf="amount?.errors?.['min'] || amount?.errors?.['max']">Invalid bid amount. Must be between ${{
            minBidAmount }} and ${{ maxBidAmount }}.</div>
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer d-flex justify-content-between">
    <button type="button"
            class="btn btn-outline-secondary"
            (click)="modal.close()">Cancel</button>
    <button type="button"
            class="btn default-btn-background"
            (click)="setBid(modal)"
            [disabled]="setBidForm.invalid">Submit</button>
  </div>
</ng-template>

<ng-template #complaintOnAuctionModal
             let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Complaint on the Auction</h4>
    <button type="button"
            class="btn-close"
            aria-label="Close"
            (click)="modal.dismiss('Cross click')"></button>
  </div>
  <div class="modal-body">
    <form *ngIf="complaintOnAuctionForm"
          [formGroup]="complaintOnAuctionForm">
      <div class="mb-3">
        <label for="complaintText"
               class="form-label fw-bold">Complaint text:</label>
        <textarea id="complaintText"
                  class="form-control"
                  rows="5"
                  formControlName="complaintText"
                  [ngClass]="{'is-invalid': !complaintOnAuctionForm.controls['complaintText'].valid && (complaintOnAuctionForm.controls['complaintText'].dirty || complaintOnAuctionForm.controls['complaintText'].touched)}"></textarea>
        <div *ngIf="!complaintOnAuctionForm.controls['complaintText'].valid && (complaintOnAuctionForm.controls['complaintText'].dirty || complaintOnAuctionForm.controls['complaintText'].touched)"
             class="invalid-feedback">
          <div *ngIf="complaintOnAuctionForm.controls['complaintText'].errors?.['required']">Complaint text is required.
          </div>
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button"
            class="btn default-btn-background"
            (click)="complainOnAuction(modal)"
            [disabled]="complaintOnAuctionForm.invalid">Submit</button>
  </div>
</ng-template>

<ng-template #cancelAuctionModal
             let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Cancel Auction</h4>
    <button type="button"
            class="btn-close"
            aria-label="Close"
            (click)="modal.dismiss('Cross click')"></button>
  </div>
  <div class="modal-body">
    <form *ngIf="cancelationForm"
          [formGroup]="cancelationForm">
      <input type="hidden"
             id="auctionId"
             formControlName="auctionId" />
      <div class="mb-3">
        <label for="cancelationReason"
               class="form-label fw-bold">Cancellation reason:</label>
        <textarea id="cancelationReason"
                  class="form-control"
                  rows="4"
                  formControlName="cancelationReason"
                  [ngClass]="{'is-invalid': !cancelationForm.controls['cancelationReason'].valid && (cancelationForm.controls['cancelationReason'].dirty || cancelationForm.controls['cancelationReason'].touched)}"></textarea>
        <div *ngIf="!cancelationForm.controls['cancelationReason'].valid && (cancelationForm.controls['cancelationReason'].dirty || cancelationForm.controls['cancelationReason'].touched)"
             class="invalid-feedback">
          <div *ngIf="cancelationForm.controls['cancelationReason'].errors?.['required']">Cancellation reason is
            required.</div>
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button"
            class="btn default-btn-background"
            (click)="cancelAuction(modal)"
            [disabled]="cancelationForm.invalid">Submit</button>
  </div>
</ng-template>

<ng-template #userBlockedModal
             let-modal>
  <div class="modal-header">
    <h4 class="modal-title text-danger">Cannot Place a Bid</h4>
    <button type="button"
            class="btn-close"
            aria-label="Close"
            (click)="modal.dismiss('Cross click')"></button>
  </div>
  <div class="modal-body">
    <p class="text-danger"><i class="fa-solid fa-triangle-exclamation me-2"></i>Your account has been blocked! You are
      currently unable to place bids.</p>
  </div>
  <div class="modal-footer">
    <button type="button"
            class="btn btn-secondary"
            (click)="modal.close()">Ok</button>
  </div>
</ng-template>

<ng-template #notAttachedPaymentModal
             let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Cannot Place a Bid</h4>
    <button type="button"
            class="btn-close"
            aria-label="Close"
            (click)="modal.dismiss('Cross click')"></button>
  </div>
  <div class="modal-body">
    You have not attached any payment method
    yet. Please attach a payment method before participating in auctions.
  </div>
  <div class="modal-footer">
    <button type="button"
            class="btn btn-secondary"
            (click)="modal.close()">Ok</button>
  </div>
</ng-template>
